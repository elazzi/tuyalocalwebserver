<!DOCTYPE html>
<html>
<head>
    <title>Tuya Local Control</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        h1, h2 { color: #333; }
        hr { border: 0; border-top: 1px solid #e0e0e0; }

        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color: 0.3s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }

        .device { background: white; border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .device-header { display: flex; justify-content: space-between; align-items: center; }
        .device-header h3 { margin: 0; color: #0056b3; }

        #discover-loader { display: none; margin-left: 10px; }
        .discovered-item { background: #fff; margin-bottom: 10px; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }

        .configured-badge { background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; font-size: 0.9em; }

        .message { padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .message.success { background-color: #d4edda; color: #155724; }
        .message.error { background-color: #f8d7da; color: #721c24; }

        .status-table { margin-top: 15px; width: 100%; border-collapse: collapse; }
        .status-table th, .status-table td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        .status-table th { background-color: #f8f9fa; }
        .status-table td:first-child { font-weight: bold; color: #555; }
        .status-table td:nth-child(3) { text-align: center; }

        /* Toggle Switch CSS */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #28a745; }
        .slider.round { border-radius: 24px; }
        .slider.round:before { border-radius: 50%; }

        /* Slider Control CSS */
        .slider-container { display: flex; align-items: center; justify-content: center; }
        .slider-container input[type=range] { flex-grow: 1; max-width: 150px; margin-right: 15px; }
        .slider-container span { font-weight: bold; min-width: 30px; text-align: right; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Tuya Device Status</h1>
            <a href="/config">Go to Configuration</a>
        </div>
        <div id="messages"></div>

        <h2>Configured Devices</h2>
        <div id="configured-devices"></div>
    </div>

    <script>
        const configuredDevicesDiv = document.getElementById('configured-devices');
        const messagesDiv = document.getElementById('messages');
        let configuredDevices = {};

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        // --- Core API Functions ---
        async function loadConfiguredDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                configuredDevices = devices;
                renderConfiguredDevices(devices);
            } catch (error) { showMessage(`Error loading configured devices: ${error.message}`, 'error'); }
        }

        async function getStatus(deviceId, isDefaultOnly = false) {
            const statusDiv = document.querySelector(`#device-${deviceId} .device-status`);
            statusDiv.innerHTML = 'Loading status...';
            clearMessages();
            try {
                const response = await fetch(`/api/devices/${deviceId}/status`);
                if (response.status === 429) {
                    statusDiv.innerHTML = `<span style="color: orange;">Server is busy scanning, status refresh queued.</span>`;
                    return;
                }
                if (!response.ok) { const data = await response.json(); throw new Error(data.detail || 'Failed to get status'); }
                const data = await response.json();
                renderDeviceStatus(deviceId, data, isDefaultOnly);
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: red;">Could not load status.</span>`;
                showMessage(`Error getting status for ${deviceId}: ${error.message}`, 'error');
            }
        }

        async function controlDevice(deviceId, command, dpIndex, value) {
            const statusDiv = document.querySelector(`#device-${deviceId} .device-status`);
            statusDiv.style.opacity = '0.5';
            clearMessages();
            try {
                const body = { command, dp_index: dpIndex, value };
                const response = await fetch(`/api/devices/${deviceId}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!response.ok) { const data = await response.json(); throw new Error(data.detail || 'Failed to control device'); }
                const data = await response.json();
                renderDeviceStatus(deviceId, data);
            } catch (error) {
                showMessage(`Error controlling device: ${error.message}`, 'error');
                getStatus(deviceId);
            } finally {
                statusDiv.style.opacity = '1';
            }
        }

        async function saveDefaultFeatures(deviceId) {
            const checkboxes = document.querySelectorAll(`#device-${deviceId} .device-status input[type="checkbox"][data-feature-code]`);
            const features = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.featureCode);

            try {
                const response = await fetch(`/api/devices/${deviceId}/set_default_features`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ features: features })
                });
                if (!response.ok) { const data = await response.json(); throw new Error(data.detail || 'Failed to save defaults'); }
                if(configuredDevices[deviceId]) {
                    configuredDevices[deviceId].default_features = features;
                }
                showMessage('Default features saved successfully!', 'success');
            } catch (error) {
                showMessage(`Error saving default features: ${error.message}`, 'error');
            }
        }

        async function removeDevice(deviceId) {
            if (!confirm('Are you sure you want to remove this device?')) return;
            try {
                const response = await fetch(`/api/devices/${deviceId}`, { method: 'DELETE' });
                if (!response.ok) { const data = await response.json(); throw new Error(data.detail || 'Failed to remove'); }
                showMessage('Device removed successfully!', 'success');
                await loadConfiguredDevices();
            } catch (error) {
                showMessage(`Error removing device: ${error.message}`, 'error');
            }
        }

        async function setGatewayStatus(deviceId, isGateway) {
            try {
                const response = await fetch(`/api/devices/${deviceId}/set_gateway`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_gateway: isGateway })
                });
                if (!response.ok) { const data = await response.json(); throw new Error(data.detail || 'Failed to set gateway status'); }
                showMessage('Gateway status updated successfully!', 'success');
                if (configuredDevices[deviceId]) {
                    configuredDevices[deviceId].is_gateway = isGateway;
                }
            } catch (error) {
                showMessage(`Error updating gateway status: ${error.message}`, 'error');
                loadConfiguredDevices(); // Revert checkbox on failure
            }
        }

        // --- Rendering Functions ---
        function renderConfiguredDevices(devices) {
            let html = Object.keys(devices).length > 0 ? '' : "<p>No devices have been configured yet. <a href='/config'>Go to configuration</a> to add devices.</p>";
            for (const deviceId in devices) {
                const device = devices[deviceId];
                html += `
                    <div class="device" id="device-${deviceId}">
                        <div class="device-header">
                            <div style="display: flex; align-items: center;">
                                ${device.icon ? `<img src="${device.icon}" alt="Device Icon" style="width: 40px; height: 40px; margin-right: 15px;">` : ''}
                                <div>
                                    <h3 style="margin: 0;">
                                        ${device.name || 'Unknown Device'}
                                        ${device.control_method === 'cloud' ? ' ☁️' : ''}
                                    </h3>
                                    <small style="color: #666;">ID: ${device.device_id}</small>
                                </div>
                            </div>
                            <div>
                                <label style="margin-right: 15px; user-select: none;">
                                    <input type="checkbox" onchange="setGatewayStatus('${deviceId}', this.checked)" ${device.is_gateway ? 'checked' : ''}> Is Gateway
                                </label>
                                <button class="secondary" onclick="getStatus('${deviceId}', false)">Refresh Status</button>
                                <button class="secondary" onclick="removeDevice('${deviceId}')" style="background-color: #dc3545; margin-left: 5px;">Remove</button>
                            </div>
                        </div>
                        <div class="device-status"></div>
                    </div>`;
            }
            configuredDevicesDiv.innerHTML = html;
            initialDeviceStatusLoad(devices);
        }

        async function initialDeviceStatusLoad(devices) {
            const devicesToUpdate = Object.keys(devices).filter(id => devices[id].default_features && devices[id].default_features.length > 0);
            for (const deviceId of devicesToUpdate) {
                await getStatus(deviceId, true);
                await sleep(1000); // Stagger status requests
            }
        }

        function renderDeviceStatus(deviceId, data, isDefaultOnly = false) {
            const statusDiv = document.querySelector(`#device-${deviceId} .device-status`);
            const { status, device_info, sub_devices } = data;
            const mapping = device_info.mapping || {};
            const codeToDpId = Object.fromEntries(Object.entries(mapping).map(([dpId, val]) => [val.code, dpId]));
            const defaultFeatures = configuredDevices[deviceId]?.default_features || [];

            let tableHtml = '';
            if (status.error) {
                tableHtml += `<p style="color: red;">Could not load device status: ${status.error}</p>`;
            } else {
                tableHtml = `<table class="status-table"><thead><tr><th>Feature</th><th>Value</th><th>Action</th><th>Default</th></tr></thead><tbody>`;
                const featuresToRender = isDefaultOnly ? defaultFeatures : Object.keys(status);

                for (const codeName of featuresToRender) {
                    if (!status[codeName]) continue;
                    const item = status[codeName];
                    const dpId = codeToDpId[codeName];
                    const dpInfo = dpId ? mapping[dpId] : null;
                    let controlHtml = 'N/A';
                    let displayValue = item.value;
                    let unit = '';

                    if (dpInfo && dpInfo.code) {
                        try {
                            const values = (typeof dpInfo.values === 'string' && dpInfo.values.trim() !== '') ? JSON.parse(dpInfo.values) : {};
                            if (dpInfo.type === 'Boolean') {
                                const command = item.value ? 'turn_off' : 'turn_on';
                                controlHtml = `<label class="switch"><input type="checkbox" ${item.value ? 'checked' : ''} onchange="controlDevice('${deviceId}', '${command}', ${dpId})"><span class="slider round"></span></label>`;
                                displayValue = item.value ? 'On' : 'Off';
                            } else if (dpInfo.type === 'Enum' && values.range) {
                                controlHtml = `<select onchange="controlDevice('${deviceId}', 'set_value', ${dpId}, this.value)">${values.range.map(v => `<option value="${v}" ${v === item.value ? 'selected' : ''}>${v}</option>`).join('')}</select>`;
                            } else if (dpInfo.type === 'Integer' && values.min !== undefined) {
                                const scale = values.scale || 0;
                                const scaledValue = (item.value / Math.pow(10, scale)).toFixed(scale);
                                controlHtml = `<div class="slider-container"><input type="range" min="${values.min}" max="${values.max}" step="${values.step || 1}" value="${item.value}" onchange="controlDevice('${deviceId}', 'set_value', ${dpId}, parseInt(this.value))" oninput="this.nextElementSibling.innerText = (this.value / ${Math.pow(10, scale)}).toFixed(${scale})"><span>${scaledValue}</span></div>`;
                                displayValue = '';
                            } else { controlHtml = 'Read-only'; }
                            if (values.unit) unit = ` ${values.unit}`;
                            if (dpInfo.type === 'Integer' && values.scale > 0) displayValue = (item.value / Math.pow(10, values.scale)).toFixed(values.scale);
                        } catch (e) { console.error("Error parsing DP values for", codeName, e); controlHtml = 'Error'; }
                    }
                    const isDefault = defaultFeatures.includes(codeName);
                    const defaultCheckbox = `<input type="checkbox" onchange="saveDefaultFeatures('${deviceId}')" data-feature-code="${codeName}" ${isDefault ? 'checked' : ''}>`;
                    tableHtml += `<tr><td>${codeName}</td><td>${displayValue}${unit}</td><td>${controlHtml}</td><td>${defaultCheckbox}</td></tr>`;
                }
                tableHtml += '</tbody></table>';
            }

            if (sub_devices) {
                tableHtml += '<h4 style="margin-top: 20px;">Sub-Devices</h4>';
                if (sub_devices.error) {
                    tableHtml += `<p style="color: red;">Could not load sub-devices: ${sub_devices.error}</p>`;
                } else if (!sub_devices.online?.length && !sub_devices.offline?.length) {
                    tableHtml += '<p>No sub-devices found.</p>';
                } else {
                    tableHtml += '<table class="status-table"><thead><tr><th>ID</th><th>Online</th></tr></thead><tbody>';
                    (sub_devices.online || []).forEach(id => {
                        tableHtml += `<tr><td>${id}</td><td>Yes</td></tr>`;
                    });
                    (sub_devices.offline || []).forEach(id => {
                        tableHtml += `<tr><td>${id}</td><td>No</td></tr>`;
                    });
                    tableHtml += '</tbody></table>';
                }
            }
            statusDiv.innerHTML = tableHtml;
        }

        // --- Utility Functions ---
        function showMessage(message, type = 'info') { messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`; }
        function clearMessages() { messagesDiv.innerHTML = ''; }

        // --- Initial Load ---
        loadConfiguredDevices();
    </script>
</body>
</html>